import React, { useState, useEffect } from 'react';
import { Star, Search, Phone, MapPin, Clock, User, Plus, X, Filter } from 'lucide-react';

const ClasificadosPanama = () => {
  const [anuncios, setAnuncios] = useState([]);
  const [categoriaFiltro, setCategoriaFiltro] = useState('todos');
  const [busqueda, setBusqueda] = useState('');
  const [mostrarFormulario, setMostrarFormulario] = useState(false);
  const [anuncioSeleccionado, setAnuncioSeleccionado] = useState(null);
  
  const categorias = [
    'PlomerÃ­a', 'Electricidad', 'Limpieza', 'CarpinterÃ­a', 
    'Pintura', 'JardinerÃ­a', 'Mudanzas', 'Reparaciones', 'Otros'
  ];

  // Cargar anuncios desde storage al iniciar
  useEffect(() => {
    cargarAnuncios();
  }, []);

  const cargarAnuncios = async () => {
    try {
      const result = await window.storage.list('anuncio:');
      if (result && result.keys) {
        const anunciosCargados = await Promise.all(
          result.keys.map(async (key) => {
            const data = await window.storage.get(key);
            return data ? JSON.parse(data.value) : null;
          })
        );
        setAnuncios(anunciosCargados.filter(a => a !== null));
      }
    } catch (error) {
      console.log('Iniciando con anuncios de ejemplo');
      setAnuncios(anunciosEjemplo);
    }
  };

  const anunciosEjemplo = [
    {
      id: '1',
      nombre: 'Carlos Mendoza',
      servicio: 'PlomerÃ­a',
      descripcion: 'ReparaciÃ³n de tuberÃ­as, instalaciones sanitarias, destapes de caÃ±erÃ­as. 15 aÃ±os de experiencia.',
      telefono: '6123-4567',
      ubicacion: 'San Francisco, PanamÃ¡',
      calificacion: 4.8,
      totalCalificaciones: 24,
      imagen: 'ðŸ”§'
    },
    {
      id: '2',
      nombre: 'MarÃ­a GonzÃ¡lez',
      servicio: 'Limpieza',
      descripcion: 'Servicio de limpieza residencial y comercial. Personal capacitado y productos de calidad.',
      telefono: '6234-5678',
      ubicacion: 'Costa del Este, PanamÃ¡',
      calificacion: 4.9,
      totalCalificaciones: 31,
      imagen: 'ðŸ§¹'
    },
    {
      id: '3',
      nombre: 'Juan PÃ©rez',
      servicio: 'Electricidad',
      descripcion: 'Instalaciones elÃ©ctricas, reparaciones, mantenimiento. Certificado y asegurado.',
      telefono: '6345-6789',
      ubicacion: 'Albrook, PanamÃ¡',
      calificacion: 4.7,
      totalCalificaciones: 18,
      imagen: 'âš¡'
    }
  ];

  const guardarAnuncio = async (nuevoAnuncio) => {
    try {
      const anuncioConId = {
        ...nuevoAnuncio,
        id: Date.now().toString(),
        calificacion: 5.0,
        totalCalificaciones: 0,
        fecha: new Date().toISOString()
      };
      
      await window.storage.set(
        `anuncio:${anuncioConId.id}`,
        JSON.stringify(anuncioConId)
      );
      
      setAnuncios([anuncioConId, ...anuncios]);
      setMostrarFormulario(false);
    } catch (error) {
      console.error('Error al guardar:', error);
      alert('Error al publicar el anuncio. Por favor intenta de nuevo.');
    }
  };

  const contactarWhatsApp = (anuncio) => {
    const mensaje = encodeURIComponent(
      `Hola ${anuncio.nombre}, quisiera mÃ¡s informaciÃ³n de su servicio`
    );
    const telefono = anuncio.telefono.replace(/[-\s]/g, '');
    window.open(`https://wa.me/507${telefono}?text=${mensaje}`, '_blank');
  };

  const anunciosFiltrados = anuncios.filter(anuncio => {
    const coincideCategoria = categoriaFiltro === 'todos' || anuncio.servicio === categoriaFiltro;
    const coincideBusqueda = anuncio.nombre.toLowerCase().includes(busqueda.toLowerCase()) ||
                             anuncio.servicio.toLowerCase().includes(busqueda.toLowerCase()) ||
                             anuncio.descripcion.toLowerCase().includes(busqueda.toLowerCase());
    return coincideCategoria && coincideBusqueda;
  });

  const FormularioAnuncio = ({ onGuardar, onCancelar }) => {
    const [form, setForm] = useState({
      nombre: '',
      servicio: 'PlomerÃ­a',
      descripcion: '',
      telefono: '',
      ubicacion: '',
      imagen: 'ðŸ”§'
    });

    const emojis = ['ðŸ”§', 'âš¡', 'ðŸ§¹', 'ðŸªš', 'ðŸŽ¨', 'ðŸŒ±', 'ðŸ“¦', 'ðŸ”¨', 'ðŸ’¼'];

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
            <h3 className="text-2xl font-bold text-gray-800">Publicar Anuncio</h3>
            <button onClick={onCancelar} className="text-gray-500 hover:text-gray-700">
              <X size={24} />
            </button>
          </div>
          
          <div className="p-6 space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo</label>
              <input
                type="text"
                value={form.nombre}
                onChange={(e) => setForm({...form, nombre: e.target.value})}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Tu nombre"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">CategorÃ­a del Servicio</label>
              <select
                value={form.servicio}
                onChange={(e) => setForm({...form, servicio: e.target.value})}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                {categorias.map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">DescripciÃ³n del Servicio</label>
              <textarea
                value={form.descripcion}
                onChange={(e) => setForm({...form, descripcion: e.target.value})}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows="4"
                placeholder="Describe tu servicio, experiencia y lo que ofreces..."
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">TelÃ©fono (WhatsApp)</label>
              <input
                type="tel"
                value={form.telefono}
                onChange={(e) => setForm({...form, telefono: e.target.value})}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="6123-4567"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">UbicaciÃ³n</label>
              <input
                type="text"
                value={form.ubicacion}
                onChange={(e) => setForm({...form, ubicacion: e.target.value})}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Ej: San Francisco, PanamÃ¡"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Selecciona un Ã­cono</label>
              <div className="flex gap-2 flex-wrap">
                {emojis.map(emoji => (
                  <button
                    key={emoji}
                    onClick={() => setForm({...form, imagen: emoji})}
                    className={`text-3xl p-3 rounded-lg border-2 transition-all ${
                      form.imagen === emoji 
                        ? 'border-blue-500 bg-blue-50 scale-110' 
                        : 'border-gray-200 hover:border-blue-300'
                    }`}
                  >
                    {emoji}
                  </button>
                ))}
              </div>
            </div>

            <button
              onClick={() => {
                if (form.nombre && form.descripcion && form.telefono && form.ubicacion) {
                  onGuardar(form);
                } else {
                  alert('Por favor completa todos los campos');
                }
              }}
              className="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg"
            >
              Publicar Anuncio
            </button>
          </div>
        </div>
      </div>
    );
  };

  const CalificarModal = ({ anuncio, onCerrar }) => {
    const [calificacion, setCalificacion] = useState(5);
    const [comentario, setComentario] = useState('');

    const guardarCalificacion = async () => {
      try {
        const anuncioActualizado = {
          ...anuncio,
          calificacion: ((anuncio.calificacion * anuncio.totalCalificaciones) + calificacion) / (anuncio.totalCalificaciones + 1),
          totalCalificaciones: anuncio.totalCalificaciones + 1
        };
        
        await window.storage.set(
          `anuncio:${anuncio.id}`,
          JSON.stringify(anuncioActualizado)
        );
        
        setAnuncios(anuncios.map(a => a.id === anuncio.id ? anuncioActualizado : a));
        onCerrar();
        alert('Â¡Gracias por tu calificaciÃ³n!');
      } catch (error) {
        console.error('Error al calificar:', error);
      }
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-2xl max-w-md w-full p-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-gray-800">Calificar Servicio</h3>
            <button onClick={onCerrar} className="text-gray-500 hover:text-gray-700">
              <X size={24} />
            </button>
          </div>
          
          <p className="text-gray-600 mb-4">Â¿CÃ³mo fue tu experiencia con {anuncio.nombre}?</p>
          
          <div className="flex justify-center gap-2 mb-6">
            {[1, 2, 3, 4, 5].map(num => (
              <button
                key={num}
                onClick={() => setCalificacion(num)}
                className="transition-transform hover:scale-110"
              >
                <Star
                  size={40}
                  fill={num <= calificacion ? '#fbbf24' : 'none'}
                  stroke={num <= calificacion ? '#fbbf24' : '#d1d5db'}
                />
              </button>
            ))}
          </div>

          <textarea
            value={comentario}
            onChange={(e) => setComentario(e.target.value)}
            placeholder="CuÃ©ntanos sobre tu experiencia (opcional)"
            className="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4"
            rows="3"
          />

          <button
            onClick={guardarCalificacion}
            className="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-white py-3 rounded-lg font-semibold hover:from-amber-600 hover:to-amber-700 transition-all"
          >
            Enviar CalificaciÃ³n
          </button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-50">
      {/* Header */}
      <header className="bg-white shadow-md sticky top-0 z-40">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">
              Clasificados PanamÃ¡
            </h1>
            <button
              onClick={() => setMostrarFormulario(true)}
              className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg"
            >
              <Plus size={20} />
              Publicar Anuncio
            </button>
          </div>

          {/* Barra de bÃºsqueda */}
          <div className="relative">
            <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
            <input
              type="text"
              placeholder="Buscar servicios, profesionales..."
              value={busqueda}
              onChange={(e) => setBusqueda(e.target.value)}
              className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>
      </header>

      <div className="container mx-auto px-4 py-8">
        {/* Filtros */}
        <div className="mb-6 flex items-center gap-4 overflow-x-auto pb-2">
          <Filter size={20} className="text-gray-600 flex-shrink-0" />
          <button
            onClick={() => setCategoriaFiltro('todos')}
            className={`px-4 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
              categoriaFiltro === 'todos'
                ? 'bg-blue-600 text-white shadow-md'
                : 'bg-white text-gray-700 hover:bg-gray-100'
            }`}
          >
            Todos
          </button>
          {categorias.map(cat => (
            <button
              key={cat}
              onClick={() => setCategoriaFiltro(cat)}
              className={`px-4 py-2 rounded-full font-medium whitespace-nowrap transition-all ${
                categoriaFiltro === cat
                  ? 'bg-blue-600 text-white shadow-md'
                  : 'bg-white text-gray-700 hover:bg-gray-100'
              }`}
            >
              {cat}
            </button>
          ))}
        </div>

        {/* Grid de anuncios */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {anunciosFiltrados.map(anuncio => (
            <div key={anuncio.id} className="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all hover:-translate-y-1">
              <div className="bg-gradient-to-br from-blue-500 to-blue-700 p-6 text-center">
                <div className="text-6xl mb-2">{anuncio.imagen}</div>
                <h3 className="text-xl font-bold text-white">{anuncio.nombre}</h3>
                <p className="text-blue-100">{anuncio.servicio}</p>
              </div>

              <div className="p-6">
                <div className="flex items-center gap-2 mb-4">
                  <div className="flex items-center">
                    <Star size={20} fill="#fbbf24" stroke="#fbbf24" />
                    <span className="ml-1 font-bold text-lg">{anuncio.calificacion.toFixed(1)}</span>
                  </div>
                  <span className="text-gray-500 text-sm">({anuncio.totalCalificaciones} reseÃ±as)</span>
                </div>

                <p className="text-gray-600 mb-4 line-clamp-3">{anuncio.descripcion}</p>

                <div className="space-y-2 mb-4">
                  <div className="flex items-center text-gray-600 text-sm">
                    <MapPin size={16} className="mr-2 text-blue-600" />
                    {anuncio.ubicacion}
                  </div>
                  <div className="flex items-center text-gray-600 text-sm">
                    <Phone size={16} className="mr-2 text-blue-600" />
                    {anuncio.telefono}
                  </div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={() => contactarWhatsApp(anuncio)}
                    className="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-all flex items-center justify-center gap-2"
                  >
                    <Phone size={18} />
                    Contactar
                  </button>
                  <button
                    onClick={() => setAnuncioSeleccionado(anuncio)}
                    className="px-4 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-all"
                  >
                    <Star size={20} />
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {anunciosFiltrados.length === 0 && (
          <div className="text-center py-12">
            <p className="text-gray-500 text-lg">No se encontraron anuncios con estos criterios</p>
          </div>
        )}
      </div>

      {mostrarFormulario && (
        <FormularioAnuncio
          onGuardar={guardarAnuncio}
          onCancelar={() => setMostrarFormulario(false)}
        />
      )}

      {anuncioSeleccionado && (
        <CalificarModal
          anuncio={anuncioSeleccionado}
          onCerrar={() => setAnuncioSeleccionado(null)}
        />
      )}
    </div>
  );
};

export default ClasificadosPanama;
